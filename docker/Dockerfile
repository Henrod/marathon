FROM golang:1.6.2-alpine

MAINTAINER TFG Co <backend@tfgco.com>

EXPOSE 80

RUN apk update
RUN apk add git make g++ nginx supervisor apache2-utils

RUN go get -u github.com/Masterminds/glide/...
RUN go get -u github.com/topfreegames/goose/cmd/goose

ADD . /go/src/git.topfreegames.com/topfreegames/marathon

WORKDIR /go/src/git.topfreegames.com/topfreegames/marathon
RUN glide install
RUN go install git.topfreegames.com/topfreegames/marathon

# BASIC AUTH
ENV BASICAUTH_USERNAME marathon
ENV BASICAUTH_PASSWORD marathon
ENV USE_BASICAUTH false

# POSTGRES
ENV MARATHON_POSTGRES_HOST 0.0.0.0
ENV MARATHON_POSTGRES_PORT 5432
ENV MARATHON_POSTGRES_USER marathon
ENV MARATHON_POSTGRES_DBNAME marathon
ENV MARATHON_SENTRY_URL ""

# REDIS
ENV MARATHON_REDIS_HOST=localhost
ENV MARATHON_REDIS_PORT=9920
ENV MARATHON_REDIS_DB=0
ENV MARATHON_REDIS_PASSWORD=""
ENV MARATHON_REDIS_MAXPOOLSIZE=20

# S3
ENV MARATHON_S3_BUCKET="tfg-push-notifications"
ENV MARATHON_S3_FOLDER="test/files"
ENV MARATHON_S3_DAYSEXPIRY=1
ENV MARATHON_S3_ACCESSKEY="ACCESS-KEY"
ENV MARATHON_S3_SECRETACCESSKEY="SECRET-ACCESS-KEY"

# WORKERS
ENV MARATHON_WORKERS_LOGGER="debug"
# FIXME: WE HAVE TO KEEP THIS IN SYNC WITH AGUIA AND WE SHOULD NOT HAVE UNDERSCORES HERE
ENV MARATHON_WORKERS_CONSUMER_CONSUMERGROUPTEMPLATE="%s-%s-cg"
ENV MARATHON_WORKERS_PRODUCER_topicTemplate="%s-%s-p"
ENV MARATHON_WORKERS_CONSUMER_topicTemplate="%s-%s-c"
ENV MARATHON_WORKERS_CONSUMER_BROKERS='["localhost:9940"]'
ENV MARATHON_WORKERS_PRODUCER_BROKERS='["localhost:9940"]'
ENV MARATHON_WORKERS_MODULES_PRODUCERS=1
ENV MARATHON_WORKERS_MODULES_BATCHPGWORKERS=1
ENV MARATHON_WORKERS_MODULES_PARSERS=1
ENV MARATHON_WORKERS_MODULES_FETCHERS=1
ENV MARATHON_WORKERS_MODULES_BUILDERS=1
ENV MARATHON_WORKERS_MODULES_PRODUCERS=1
ENV MARATHON_WORKERS_MODULES_BATCHPGWORKERSTATUSDONECHAN=1
ENV MARATHON_WORKERS_MODULES_BATCHPGWORKERDONECHAN=1
ENV MARATHON_WORKERS_MODULES_PGTOPARSERCHAN=10000
ENV MARATHON_WORKERS_MODULES_PARSERDONECHAN=1
ENV MARATHON_WORKERS_MODULES_PARSERTOFETCHERCHAN=1000
ENV MARATHON_WORKERS_MODULES_FETCHERDONECHAN=1
ENV MARATHON_WORKERS_MODULES_FETCHERTOBUILDERCHAN=1000
ENV MARATHON_WORKERS_MODULES_BUILDERDONECHAN=1
ENV MARATHON_WORKERS_MODULES_BUILDERTOPRODUCERCHAN=1000
ENV MARATHON_WORKERS_MODULES_PRODUCERDONECHAN=1


RUN mkdir -p /etc/nginx/sites-enabled

# configure supervisord
ADD ./docker/deploy/supervisord-marathon.conf /etc/supervisord-marathon.conf

# Configure nginx
ADD ./docker/deploy/nginx_conf /etc/nginx/nginx.conf

CMD /bin/sh -l -c docker/start.sh
